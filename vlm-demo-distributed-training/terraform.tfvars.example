#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                                                                                      #
#                                              Terraform - example values                                              #
#                                                                                                                      #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#

# IMPORTANT: Copy this file to terraform.tfvars and fill in your actual values
# DO NOT commit terraform.tfvars to version control - it contains sensitive information

# Name of the company. It is used for context name of the cluster in .kubeconfig file.
company_name = "your-company-name"
iam_project_id = "project-YOUR_PROJECT_ID"
iam_tenant_id = "tenant-YOUR_TENANT_ID"
iam_token = "YOUR_IAM_TOKEN_HERE"
o11y_iam_group_id = "group-YOUR_GROUP_ID"
o11y_iam_project_id = "project-YOUR_O11Y_PROJECT_ID"
o11y_iam_tenant_id = "tenant-YOUR_O11Y_TENANT_ID"
o11y_profile = "your-profile-name"
region = "eu-north1"
vpc_subnet_id = "vpcsubnet-YOUR_SUBNET_ID"

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                                                                                      #
#                                                    Infrastructure                                                    #
#                                                                                                                      #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region Infrastructure

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                        Storage                                                       #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region Storage

# Shared filesystem to be used on controller nodes.
filestore_controller_spool = {
  spec = {
    size_gibibytes       = 128
    block_size_kibibytes = 4
  }
}

# Shared filesystem to be used on controller, worker, and login nodes.
# Notice that auto-backups are enabled for filesystems with size less than 12 TiB.
filestore_jail = {
   spec = {
     size_gibibytes       = 4096
     block_size_kibibytes = 4
   }
 }

# Additional shared filesystems to be mounted inside jail.
filestore_jail_submounts = [{
  name       = "models"
  mount_path = "/mnt/models"
  spec = {
    size_gibibytes       = 2048
    block_size_kibibytes = 4
  }
}, {
  name       = "datasets"
  mount_path = "/mnt/datasets"
  spec = {
    size_gibibytes       = 1024
    block_size_kibibytes = 4
  }
}]

# Additional node-local Network-SSD disks to be mounted inside jail on worker nodes.
node_local_jail_submounts = [{
  name            = "training-cache"
  mount_path      = "/mnt/training-cache"
  size_gibibytes  = 1860  # Divisible by 93
  disk_type       = "NETWORK_SSD_NON_REPLICATED"
  filesystem_type = "ext4"
}]

# Extra NRD disks for storing Docker/Enroot images and container filesystems
node_local_image_disk = {
  enabled = true
  spec = {
    size_gibibytes  = 930
    filesystem_type = "ext4"
    disk_type = "NETWORK_SSD_IO_M3"
  }
}

# Shared filesystem for accounting DB (required if accounting_enabled is true)
filestore_accounting = {
  spec = {
    size_gibibytes       = 512
    block_size_kibibytes = 4
  }
}

# endregion Storage

# region nfs-server

nfs = {
  enabled        = true
  size_gibibytes = 3720
  mount_path     = "/home"
  resource = {
    platform = "cpu-d3"
    preset   = "32vcpu-128gb"
  }
  public_ip = false
}

# endregion nfs-server

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                                                                                      #
#                                                         Slurm                                                        #
#                                                                                                                      #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region Slurm

# Version of soperator
slurm_operator_version = "1.21.9"
slurm_operator_stable = true

# Partition configuration
slurm_partition_config_type = "default"

# Worker features configuration
slurm_worker_features = [
   {
     name = "low_priority"
     hostlist_expr = "worker-[0-0]"
     nodeset_name = "low_priority"
   },
   {
     name = "low_priority"
     hostlist_expr = "worker-1"
     nodeset_name = "high_priority"
   }
 ]

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                         Nodes                                                        #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region Nodes

# System node set configuration
slurm_nodeset_system = {
  min_size = 3
  max_size = 9
  resource = {
    platform = "cpu-d3"
    preset   = "8vcpu-32gb"
  }
  boot_disk = {
    type                 = "NETWORK_SSD"
    size_gibibytes       = 192
    block_size_kibibytes = 4
  }
}

# Controller node set configuration
slurm_nodeset_controller = {
  size = 2
  resource = {
    platform = "cpu-d3"
    preset   = "4vcpu-16gb"
  }
  boot_disk = {
    type                 = "NETWORK_SSD"
    size_gibibytes       = 256
    block_size_kibibytes = 4
  }
}

# Worker node set configuration (GPU nodes)
slurm_nodeset_workers = [{
  size                    = 1
  nodes_per_nodegroup     = 1
  max_unavailable_percent = 33
  resource = {
    platform = "gpu-h100-sxm"
    preset   = "8gpu-128vcpu-1600gb"
  }
  boot_disk = {
    type                 = "NETWORK_SSD"
    size_gibibytes       = 512
    block_size_kibibytes = 4
  }
  gpu_cluster = {
    infiniband_fabric = "fabric-2"
  }
}]

# Login node set configuration
slurm_nodeset_login = {
  size = 2
  resource = {
    platform = "cpu-d3"
    preset   = "32vcpu-128gb"
  }
  boot_disk = {
    type                 = "NETWORK_SSD"
    size_gibibytes       = 256
    block_size_kibibytes = 4
  }
}

# Accounting node set configuration
slurm_nodeset_accounting = {
  resource = {
    platform = "cpu-d3"
    preset   = "8vcpu-32gb"
  }
  boot_disk = {
    type                 = "NETWORK_SSD"
    size_gibibytes       = 128
    block_size_kibibytes = 4
  }
}

#----------------------------------------------------------------------------------------------------------------------#
#                                                         Login                                                        #
#----------------------------------------------------------------------------------------------------------------------#
# region Login

# REPLACE WITH YOUR ACTUAL SSH PUBLIC KEYS
slurm_login_ssh_root_public_keys = [
  "ssh-rsa YOUR_SSH_PUBLIC_KEY_HERE your-email@example.com",
]

# endregion Login

#----------------------------------------------------------------------------------------------------------------------#
#                                                       Exporter                                                       #
#----------------------------------------------------------------------------------------------------------------------#
# region Exporter

slurm_exporter_enabled = true

# endregion Exporter

# endregion Nodes

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                        Config                                                        #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region Config

slurm_shared_memory_size_gibibytes = 1024

# endregion Config

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                    NCCL benchmark                                                    #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region NCCL benchmark

nccl_benchmark_enable = false
nccl_benchmark_schedule = "0 */3 * * *"
nccl_benchmark_min_threshold = 420
nccl_use_infiniband = false

# endregion NCCL benchmark

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                       Telemetry                                                      #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region Telemetry

telemetry_enabled = true
dcgm_job_mapping_enabled = true
public_o11y_enabled = true

# endregion Telemetry

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                       Accounting                                                     #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region Accounting

accounting_enabled = true

# endregion Accounting

# endregion Slurm

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                       Backups                                                        #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region Backups

backups_enabled = "auto"
backups_password = "CHANGE_THIS_PASSWORD"
backups_schedule = "@daily-random"
backups_prune_schedule = "@daily-random"
backups_retention = {
  keepDaily = 7
}
cleanup_bucket_on_destroy = false

# endregion Backups

#----------------------------------------------------------------------------------------------------------------------#
#                                                                                                                      #
#                                                      Kubernetes                                                      #
#                                                                                                                      #
#----------------------------------------------------------------------------------------------------------------------#
# region k8s

# k8s_version = 1.30

# endregion k8s